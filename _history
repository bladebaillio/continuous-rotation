{"entries":[{"timestamp":1764035733609,"editorVersion":"2.0.62","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":133,"diffs":[[1,"<xml xmlns=\"http://www.w3.org/1999/xhtml\">\n  <variables></variables>\n  <block type=\"pxt-on-start\" x=\"0\" y=\"0\"></block>\n</xml>"]]}]},{"type":"edited","filename":"main.ts","patch":[{"start1":0,"length1":1,"diffs":[[1," "]]}]},{"type":"edited","filename":"pxt.json","patch":[{"start1":2,"length1":34,"diffs":[[1,"    \"name\": \"continuesRotation\",\n"]]},{"start1":187,"length1":51,"diffs":[[1,"        \"assets.json\"\n"]]},{"start1":216,"length1":31,"diffs":[[1,"    \"additionalFilePaths\": []\n"]]}]},{"type":"added","filename":"spriteRotation.ts","value":"//% weight=100 color=#ff6600 icon=\"\\uf021\"\nnamespace spriteRotate {\n    interface SpriteRotationData {\n        originalImage: Image;\n        currentRotation: number;\n        isFlippedY: boolean;\n        transformedImage?: Image;\n    }\n\n    const spriteData: { [key: number]: SpriteRotationData } = {};\n\n    let lastValidLeftState = false;\n    let lastValidRightState = false;\n    let inputProtectionEnabled = false;\n\n    //% block=\"enable sprite rotation input protection\"\n    //% weight=75\n    export function enableInputProtection(): void {\n        inputProtectionEnabled = true;\n    }\n\n    function shouldProcessTransformation(): boolean {\n        if (!inputProtectionEnabled) return true;\n\n        let leftPressed = controller.left.isPressed();\n        let rightPressed = controller.right.isPressed();\n\n        if (leftPressed && rightPressed) {\n            return false;\n        }\n\n        if (leftPressed && !rightPressed) {\n            lastValidLeftState = true;\n            lastValidRightState = false;\n        } else if (rightPressed && !leftPressed) {\n            lastValidLeftState = false;\n            lastValidRightState = true;\n        }\n\n        return true;\n    }\n\n    //% block=\"set %sprite=variables_get(mySprite) rotation to %angle degrees\"\n    //% weight=100\n    export function setRotation(sprite: Sprite, angle: number): void {\n        if (!sprite) return;\n        const spriteId = sprite.id;\n\n        if (!spriteData[spriteId]) {\n            spriteData[spriteId] = {\n                originalImage: sprite.image.clone(),\n                currentRotation: 0,\n                isFlippedY: false\n            };\n        }\n\n        const data = spriteData[spriteId];\n        const normalizedAngle = ((angle % 360) + 360) % 360;\n\n        if (data.currentRotation !== normalizedAngle) {\n            data.currentRotation = normalizedAngle;\n            applyTransformation(sprite, data);\n        }\n    }\n\n    //% block=\"set %sprite=variables_get(mySprite) vertical flip %flipped\"\n    //% weight=95\n    export function setVerticalFlip(sprite: Sprite, flipped: boolean): void {\n        if (!sprite) return;\n\n        if (!shouldProcessTransformation()) {\n            return;\n        }\n\n        const spriteId = sprite.id;\n\n        if (!spriteData[spriteId]) {\n            spriteData[spriteId] = {\n                originalImage: sprite.image.clone(),\n                currentRotation: 0,\n                isFlippedY: false\n            };\n        }\n\n        const data = spriteData[spriteId];\n\n        if (data.isFlippedY !== flipped) {\n            data.isFlippedY = flipped;\n            applyTransformation(sprite, data);\n        }\n    }\n\n    //% block=\"make %sprite1=variables_get(mySprite) rotate towards %sprite2=variables_get(mySprite2) with offset %offset degrees\"\n    //% weight=89\n    export function rotateTowardsWithOffset(sprite1: Sprite, sprite2: Sprite, offset: number): void {\n        if (!sprite1 || !sprite2) return;\n        const deltaX = sprite2.x - sprite1.x;\n        const deltaY = sprite2.y - sprite1.y;\n        const angleRadians = Math.atan2(deltaY, deltaX);\n        const angleDegrees = angleRadians * (180 / Math.PI) + offset;\n        setRotation(sprite1, angleDegrees);\n    }\n\n    //% block=\"continuously make %sprite1=variables_get(mySprite) rotate towards %sprite2=variables_get(mySprite2) with offset %offset degrees\"\n    //% weight=79\n    export function continuouslyRotateTowardsWithOffset(sprite1: Sprite, sprite2: Sprite, offset: number): void {\n        if (!sprite1 || !sprite2) return;\n        rotateTowardsWithOffset(sprite1, sprite2, offset);\n\n        game.onUpdate(() => {\n            if (!sprite1 || !sprite2) return;\n            rotateTowardsWithOffset(sprite1, sprite2, offset);\n        });\n    }\n\n    //% block=\"get rotated image of %sprite=variables_get(mySprite)\"\n    //% weight=70\n    export function getRotatedImage(sprite: Sprite): Image {\n        if (!sprite) return null;\n        const data = spriteData[sprite.id];\n        if (data && data.transformedImage) {\n            return data.transformedImage.clone();\n        }\n\n        let src = data ? data.originalImage.clone() : sprite.image.clone();\n        if (data && data.isFlippedY) src = flipImageVertically(src);\n        if (data && data.currentRotation !== 0) src = rotateImage(src, data.currentRotation);\n        return src;\n    }\n\n    function applyTransformation(sprite: Sprite, data: SpriteRotationData): void {\n        const currentX = sprite.x;\n        const currentY = sprite.y;\n        let transformedImage = data.originalImage.clone();\n\n        if (data.isFlippedY) {\n            transformedImage = flipImageVertically(transformedImage);\n        }\n\n        if (data.currentRotation !== 0) {\n            transformedImage = rotateImage(transformedImage, data.currentRotation);\n        }\n\n        data.transformedImage = transformedImage;\n\n        sprite.setImage(transformedImage);\n        sprite.setPosition(currentX, currentY);\n    }\n\n    function flipImageVertically(img: Image): Image {\n        const width = img.width;\n        const height = img.height;\n        const flippedImg = image.create(width, height);\n        for (let x = 0; x < width; x++) {\n            for (let y = 0; y < height; y++) {\n                const color = img.getPixel(x, y);\n                flippedImg.setPixel(x, height - 1 - y, color);\n            }\n        }\n        return flippedImg;\n    }\n\n    function rotateImage(img: Image, angleDegrees: number): Image {\n        const angleRadians = angleDegrees * Math.PI / 180;\n        const cos = Math.cos(angleRadians);\n        const sin = Math.sin(angleRadians);\n        const width = img.width;\n        const height = img.height;\n        const newWidth = Math.ceil(Math.abs(width * cos) + Math.abs(height * sin));\n        const newHeight = Math.ceil(Math.abs(width * sin) + Math.abs(height * cos));\n        const rotatedImg = image.create(newWidth, newHeight);\n        const centerX = width / 2;\n        const centerY = height / 2;\n        const newCenterX = newWidth / 2;\n        const newCenterY = newHeight / 2;\n\n        for (let x = 0; x < newWidth; x++) {\n            for (let y = 0; y < newHeight; y++) {\n                const translatedX = x - newCenterX;\n                const translatedY = y - newCenterY;\n                const sourceX = Math.round(translatedX * cos + translatedY * sin + centerX);\n                const sourceY = Math.round(-translatedX * sin + translatedY * cos + centerY);\n\n                if (sourceX >= 0 && sourceX < width && sourceY >= 0 && sourceY < height) {\n                    const color = img.getPixel(sourceX, sourceY);\n                    if (color !== 0) {\n                        rotatedImg.setPixel(x, y, color);\n                    }\n                }\n            }\n        }\n        return rotatedImg;\n    }\n}\n"}]},{"timestamp":1769306112119,"editorVersion":"2.0.63","changes":[{"type":"edited","filename":"pxt.json","patch":[{"start1":246,"length1":35,"diffs":[[1,"    \"preferredEditor\": \"tsprj\"\n"]]}]}]},{"timestamp":1769306164785,"editorVersion":"2.0.63","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":139,"diffs":[[1,"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables></variables><block type=\"pxt-on-start\" x=\"10\" y=\"10\"></block></xml>"]]}]},{"type":"edited","filename":"pxt.json","patch":[{"start1":246,"length1":75,"diffs":[[1,"    \"preferredEditor\": \"blocksprj\"\n"]]}]},{"type":"edited","filename":"spriteRotation.ts","patch":[{"start1":43,"length1":21,"diffs":[[1,"namespace spriteRotate {\n"]]}]},{"type":"added","filename":"test.ts","value":"// tests go here; this will not be compiled when this package is used as an extension.\n"}]}],"snapshots":[{"timestamp":1764035733608,"editorVersion":"2.0.62","text":{"main.blocks":"<xml xmlns=\"http://www.w3.org/1999/xhtml\">\n  <variables></variables>\n  <block type=\"pxt-on-start\" x=\"0\" y=\"0\"></block>\n</xml>","main.ts":" ","README.md":" ","assets.json":"","pxt.json":"{\n    \"name\": \"continuesRotation\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"device\": \"*\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\",\n        \"assets.json\"\n    ],\n    \"additionalFilePaths\": []\n}\n"}},{"timestamp":1768700119276,"editorVersion":"2.0.63","text":{"main.blocks":"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables></variables><block type=\"pxt-on-start\" x=\"0\" y=\"0\"></block></xml>","main.ts":"\n","README.md":" ","assets.json":"","spriteRotation.ts":"//% weight=100 color=#ff6600 icon=\"\\uf021\"\nnamespace spriteRotate {\n    interface SpriteRotationData {\n        originalImage: Image;\n        currentRotation: number;\n        isFlippedY: boolean;\n        transformedImage?: Image;\n    }\n\n    const spriteData: { [key: number]: SpriteRotationData } = {};\n\n    let lastValidLeftState = false;\n    let lastValidRightState = false;\n    let inputProtectionEnabled = false;\n\n    //% block=\"enable sprite rotation input protection\"\n    //% weight=75\n    export function enableInputProtection(): void {\n        inputProtectionEnabled = true;\n    }\n\n    function shouldProcessTransformation(): boolean {\n        if (!inputProtectionEnabled) return true;\n\n        let leftPressed = controller.left.isPressed();\n        let rightPressed = controller.right.isPressed();\n\n        if (leftPressed && rightPressed) {\n            return false;\n        }\n\n        if (leftPressed && !rightPressed) {\n            lastValidLeftState = true;\n            lastValidRightState = false;\n        } else if (rightPressed && !leftPressed) {\n            lastValidLeftState = false;\n            lastValidRightState = true;\n        }\n\n        return true;\n    }\n\n    //% block=\"set %sprite=variables_get(mySprite) rotation to %angle degrees\"\n    //% weight=100\n    export function setRotation(sprite: Sprite, angle: number): void {\n        if (!sprite) return;\n        const spriteId = sprite.id;\n\n        if (!spriteData[spriteId]) {\n            spriteData[spriteId] = {\n                originalImage: sprite.image.clone(),\n                currentRotation: 0,\n                isFlippedY: false\n            };\n        }\n\n        const data = spriteData[spriteId];\n        const normalizedAngle = ((angle % 360) + 360) % 360;\n\n        if (data.currentRotation !== normalizedAngle) {\n            data.currentRotation = normalizedAngle;\n            applyTransformation(sprite, data);\n        }\n    }\n\n    //% block=\"set %sprite=variables_get(mySprite) vertical flip %flipped\"\n    //% weight=95\n    export function setVerticalFlip(sprite: Sprite, flipped: boolean): void {\n        if (!sprite) return;\n\n        if (!shouldProcessTransformation()) {\n            return;\n        }\n\n        const spriteId = sprite.id;\n\n        if (!spriteData[spriteId]) {\n            spriteData[spriteId] = {\n                originalImage: sprite.image.clone(),\n                currentRotation: 0,\n                isFlippedY: false\n            };\n        }\n\n        const data = spriteData[spriteId];\n\n        if (data.isFlippedY !== flipped) {\n            data.isFlippedY = flipped;\n            applyTransformation(sprite, data);\n        }\n    }\n\n    //% block=\"make %sprite1=variables_get(mySprite) rotate towards %sprite2=variables_get(mySprite2) with offset %offset degrees\"\n    //% weight=89\n    export function rotateTowardsWithOffset(sprite1: Sprite, sprite2: Sprite, offset: number): void {\n        if (!sprite1 || !sprite2) return;\n        const deltaX = sprite2.x - sprite1.x;\n        const deltaY = sprite2.y - sprite1.y;\n        const angleRadians = Math.atan2(deltaY, deltaX);\n        const angleDegrees = angleRadians * (180 / Math.PI) + offset;\n        setRotation(sprite1, angleDegrees);\n    }\n\n    //% block=\"continuously make %sprite1=variables_get(mySprite) rotate towards %sprite2=variables_get(mySprite2) with offset %offset degrees\"\n    //% weight=79\n    export function continuouslyRotateTowardsWithOffset(sprite1: Sprite, sprite2: Sprite, offset: number): void {\n        if (!sprite1 || !sprite2) return;\n        // apply once immediately so a rotated image exists right away\n        rotateTowardsWithOffset(sprite1, sprite2, offset);\n\n        game.onUpdate(() => {\n            if (!sprite1 || !sprite2) return;\n            rotateTowardsWithOffset(sprite1, sprite2, offset);\n        });\n    }\n\n    //% block=\"get rotated image of %sprite=variables_get(mySprite)\"\n    //% weight=70\n    export function getRotatedImage(sprite: Sprite): Image {\n        if (!sprite) return null;\n        const data = spriteData[sprite.id];\n        if (data && data.transformedImage) {\n            return data.transformedImage.clone();\n        }\n\n        let src = data ? data.originalImage.clone() : sprite.image.clone();\n        if (data && data.isFlippedY) src = flipImageVertically(src);\n        if (data && data.currentRotation !== 0) src = rotateImage(src, data.currentRotation);\n        return src;\n    }\n\n    function applyTransformation(sprite: Sprite, data: SpriteRotationData): void {\n        const currentX = sprite.x;\n        const currentY = sprite.y;\n        let transformedImage = data.originalImage.clone();\n\n        if (data.isFlippedY) {\n            transformedImage = flipImageVertically(transformedImage);\n        }\n\n        if (data.currentRotation !== 0) {\n            transformedImage = rotateImage(transformedImage, data.currentRotation);\n        }\n\n        data.transformedImage = transformedImage;\n\n        sprite.setImage(transformedImage);\n        sprite.setPosition(currentX, currentY);\n    }\n\n    function flipImageVertically(img: Image): Image {\n        const width = img.width;\n        const height = img.height;\n        const flippedImg = image.create(width, height);\n        for (let x = 0; x < width; x++) {\n            for (let y = 0; y < height; y++) {\n                const color = img.getPixel(x, y);\n                flippedImg.setPixel(x, height - 1 - y, color);\n            }\n        }\n        return flippedImg;\n    }\n\n    function rotateImage(img: Image, angleDegrees: number): Image {\n        const angleRadians = angleDegrees * Math.PI / 180;\n        const cos = Math.cos(angleRadians);\n        const sin = Math.sin(angleRadians);\n        const width = img.width;\n        const height = img.height;\n        const newWidth = Math.ceil(Math.abs(width * cos) + Math.abs(height * sin));\n        const newHeight = Math.ceil(Math.abs(width * sin) + Math.abs(height * cos));\n        const rotatedImg = image.create(newWidth, newHeight);\n        const centerX = width / 2;\n        const centerY = height / 2;\n        const newCenterX = newWidth / 2;\n        const newCenterY = newHeight / 2;\n\n        for (let x = 0; x < newWidth; x++) {\n            for (let y = 0; y < newHeight; y++) {\n                const translatedX = x - newCenterX;\n                const translatedY = y - newCenterY;\n                const sourceX = Math.round(translatedX * cos + translatedY * sin + centerX);\n                const sourceY = Math.round(-translatedX * sin + translatedY * cos + centerY);\n\n                if (sourceX >= 0 && sourceX < width && sourceY >= 0 && sourceY < height) {\n                    const color = img.getPixel(sourceX, sourceY);\n                    if (color !== 0) {\n                        rotatedImg.setPixel(x, y, color);\n                    }\n                }\n            }\n        }\n        return rotatedImg;\n    }\n}\n","pxt.json":"{\n    \"name\": \"continuesRotation\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"device\": \"*\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\",\n        \"assets.json\",\n        \"spriteRotation.ts\"\n    ],\n    \"preferredEditor\": \"tsprj\"\n}\n"}},{"timestamp":1769306112119,"editorVersion":"2.0.63","text":{"main.blocks":"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables></variables><block type=\"pxt-on-start\" x=\"0\" y=\"0\"></block></xml>","main.ts":"\n","README.md":" ","assets.json":"","spriteRotation.ts":"//% weight=100 color=#ff6600 icon=\"\\uf021\"\nnamespace spriteRotate {\n    interface SpriteRotationData {\n        originalImage: Image;\n        currentRotation: number;\n        isFlippedY: boolean;\n        transformedImage?: Image;\n    }\n\n    const spriteData: { [key: number]: SpriteRotationData } = {};\n\n    let lastValidLeftState = false;\n    let lastValidRightState = false;\n    let inputProtectionEnabled = false;\n\n    //% block=\"enable sprite rotation input protection\"\n    //% weight=75\n    export function enableInputProtection(): void {\n        inputProtectionEnabled = true;\n    }\n\n    function shouldProcessTransformation(): boolean {\n        if (!inputProtectionEnabled) return true;\n\n        let leftPressed = controller.left.isPressed();\n        let rightPressed = controller.right.isPressed();\n\n        if (leftPressed && rightPressed) {\n            return false;\n        }\n\n        if (leftPressed && !rightPressed) {\n            lastValidLeftState = true;\n            lastValidRightState = false;\n        } else if (rightPressed && !leftPressed) {\n            lastValidLeftState = false;\n            lastValidRightState = true;\n        }\n\n        return true;\n    }\n\n    //% block=\"set %sprite=variables_get(mySprite) rotation to %angle degrees\"\n    //% weight=100\n    export function setRotation(sprite: Sprite, angle: number): void {\n        if (!sprite) return;\n        const spriteId = sprite.id;\n\n        if (!spriteData[spriteId]) {\n            spriteData[spriteId] = {\n                originalImage: sprite.image.clone(),\n                currentRotation: 0,\n                isFlippedY: false\n            };\n        }\n\n        const data = spriteData[spriteId];\n        const normalizedAngle = ((angle % 360) + 360) % 360;\n\n        if (data.currentRotation !== normalizedAngle) {\n            data.currentRotation = normalizedAngle;\n            applyTransformation(sprite, data);\n        }\n    }\n\n    //% block=\"set %sprite=variables_get(mySprite) vertical flip %flipped\"\n    //% weight=95\n    export function setVerticalFlip(sprite: Sprite, flipped: boolean): void {\n        if (!sprite) return;\n\n        if (!shouldProcessTransformation()) {\n            return;\n        }\n\n        const spriteId = sprite.id;\n\n        if (!spriteData[spriteId]) {\n            spriteData[spriteId] = {\n                originalImage: sprite.image.clone(),\n                currentRotation: 0,\n                isFlippedY: false\n            };\n        }\n\n        const data = spriteData[spriteId];\n\n        if (data.isFlippedY !== flipped) {\n            data.isFlippedY = flipped;\n            applyTransformation(sprite, data);\n        }\n    }\n\n    //% block=\"make %sprite1=variables_get(mySprite) rotate towards %sprite2=variables_get(mySprite2) with offset %offset degrees\"\n    //% weight=89\n    export function rotateTowardsWithOffset(sprite1: Sprite, sprite2: Sprite, offset: number): void {\n        if (!sprite1 || !sprite2) return;\n        const deltaX = sprite2.x - sprite1.x;\n        const deltaY = sprite2.y - sprite1.y;\n        const angleRadians = Math.atan2(deltaY, deltaX);\n        const angleDegrees = angleRadians * (180 / Math.PI) + offset;\n        setRotation(sprite1, angleDegrees);\n    }\n\n    //% block=\"continuously make %sprite1=variables_get(mySprite) rotate towards %sprite2=variables_get(mySprite2) with offset %offset degrees\"\n    //% weight=79\n    export function continuouslyRotateTowardsWithOffset(sprite1: Sprite, sprite2: Sprite, offset: number): void {\n        if (!sprite1 || !sprite2) return;\n        rotateTowardsWithOffset(sprite1, sprite2, offset);\n\n        game.onUpdate(() => {\n            if (!sprite1 || !sprite2) return;\n            rotateTowardsWithOffset(sprite1, sprite2, offset);\n        });\n    }\n\n    //% block=\"get rotated image of %sprite=variables_get(mySprite)\"\n    //% weight=70\n    export function getRotatedImage(sprite: Sprite): Image {\n        if (!sprite) return null;\n        const data = spriteData[sprite.id];\n        if (data && data.transformedImage) {\n            return data.transformedImage.clone();\n        }\n\n        let src = data ? data.originalImage.clone() : sprite.image.clone();\n        if (data && data.isFlippedY) src = flipImageVertically(src);\n        if (data && data.currentRotation !== 0) src = rotateImage(src, data.currentRotation);\n        return src;\n    }\n\n    function applyTransformation(sprite: Sprite, data: SpriteRotationData): void {\n        const currentX = sprite.x;\n        const currentY = sprite.y;\n        let transformedImage = data.originalImage.clone();\n\n        if (data.isFlippedY) {\n            transformedImage = flipImageVertically(transformedImage);\n        }\n\n        if (data.currentRotation !== 0) {\n            transformedImage = rotateImage(transformedImage, data.currentRotation);\n        }\n\n        data.transformedImage = transformedImage;\n\n        sprite.setImage(transformedImage);\n        sprite.setPosition(currentX, currentY);\n    }\n\n    function flipImageVertically(img: Image): Image {\n        const width = img.width;\n        const height = img.height;\n        const flippedImg = image.create(width, height);\n        for (let x = 0; x < width; x++) {\n            for (let y = 0; y < height; y++) {\n                const color = img.getPixel(x, y);\n                flippedImg.setPixel(x, height - 1 - y, color);\n            }\n        }\n        return flippedImg;\n    }\n\n    function rotateImage(img: Image, angleDegrees: number): Image {\n        const angleRadians = angleDegrees * Math.PI / 180;\n        const cos = Math.cos(angleRadians);\n        const sin = Math.sin(angleRadians);\n        const width = img.width;\n        const height = img.height;\n        const newWidth = Math.ceil(Math.abs(width * cos) + Math.abs(height * sin));\n        const newHeight = Math.ceil(Math.abs(width * sin) + Math.abs(height * cos));\n        const rotatedImg = image.create(newWidth, newHeight);\n        const centerX = width / 2;\n        const centerY = height / 2;\n        const newCenterX = newWidth / 2;\n        const newCenterY = newHeight / 2;\n\n        for (let x = 0; x < newWidth; x++) {\n            for (let y = 0; y < newHeight; y++) {\n                const translatedX = x - newCenterX;\n                const translatedY = y - newCenterY;\n                const sourceX = Math.round(translatedX * cos + translatedY * sin + centerX);\n                const sourceY = Math.round(-translatedX * sin + translatedY * cos + centerY);\n\n                if (sourceX >= 0 && sourceX < width && sourceY >= 0 && sourceY < height) {\n                    const color = img.getPixel(sourceX, sourceY);\n                    if (color !== 0) {\n                        rotatedImg.setPixel(x, y, color);\n                    }\n                }\n            }\n        }\n        return rotatedImg;\n    }\n}\n","pxt.json":"{\n    \"name\": \"continuousRotation\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"device\": \"*\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\",\n        \"assets.json\",\n        \"spriteRotation.ts\"\n    ],\n    \"preferredEditor\": \"tsprj\"\n}\n"}}],"shares":[],"lastSaveTime":1769306348286}